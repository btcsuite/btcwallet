#!/usr/bin/env bash
# Merge SQL migration files into single files for postgresql or sqlite
#
# Usage:
#   ./scripts/merge_migrations.sh postgres up    # Merge postgres UP migrations (ascending)
#   ./scripts/merge_migrations.sh sqlite down    # Merge sqlite DOWN migrations (descending)
#   ./scripts/merge_migrations.sh postgres       # Merge both UP and DOWN for postgres
#   ./scripts/merge_migrations.sh                # Merge both UP and DOWN for both databases

set -e

# Base directory for migrations
MIGRATIONS_BASE="wallet/internal/db/migrations"

# Function to merge UP migrations (ascending order)
merge_up_migrations() {
    local dialect=$1
    local migrations_dir="${MIGRATIONS_BASE}/${dialect}"
    local output_file="${migrations_dir}/merged_up.sql"

    echo "Merging UP migrations for ${dialect}..."

    # Remove old merged file if exists
    rm -f "${output_file}"

    # Add header
    cat > "${output_file}" << EOF
-- Merged UP migrations for ${dialect}
-- Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
-- DO NOT EDIT THIS FILE MANUALLY - it is auto-generated
--
EOF

    # Find all .up.sql files and sort them numerically
    local count=0
    for migration in $(find "${migrations_dir}" -name "*.up.sql" -type f | sort -V); do
        # Skip the merged file itself
        if [[ "$(basename "${migration}")" == "merged_up.sql" ]]; then
            continue
        fi

        echo "-- ============================================" >> "${output_file}"
        echo "-- Migration: $(basename "${migration}")" >> "${output_file}"
        echo "-- ============================================" >> "${output_file}"
        echo "" >> "${output_file}"
        cat "${migration}" >> "${output_file}"
        echo "" >> "${output_file}"
        echo "" >> "${output_file}"

        ((count++))
    done

    echo "✓ Merged ${count} UP migrations into ${output_file}"
}

# Function to merge DOWN migrations (descending order)
merge_down_migrations() {
    local dialect=$1
    local migrations_dir="${MIGRATIONS_BASE}/${dialect}"
    local output_file="${migrations_dir}/merged_down.sql"

    echo "Merging DOWN migrations for ${dialect}..."

    # Remove old merged file if exists
    rm -f "${output_file}"

    # Add header
    cat > "${output_file}" << EOF
-- Merged DOWN migrations for ${dialect}
-- Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
-- DO NOT EDIT THIS FILE MANUALLY - it is auto-generated
--
EOF

    # Find all .down.sql files and sort them numerically in REVERSE order
    local count=0
    for migration in $(find "${migrations_dir}" -name "*.down.sql" -type f | sort -rV); do
        # Skip the merged file itself
        if [[ "$(basename "${migration}")" == "merged_down.sql" ]]; then
            continue
        fi

        echo "-- ============================================" >> "${output_file}"
        echo "-- Migration: $(basename "${migration}")" >> "${output_file}"
        echo "-- ============================================" >> "${output_file}"
        echo "" >> "${output_file}"
        cat "${migration}" >> "${output_file}"
        echo "" >> "${output_file}"
        echo "" >> "${output_file}"

        ((count++))
    done

    echo "✓ Merged ${count} DOWN migrations into ${output_file}"
}

# Main script logic
DIALECT="${1:-}"
DIRECTION="${2:-}"

if [[ -z "${DIALECT}" ]]; then
    # No arguments: merge everything
    echo "Merging all migrations for all databases..."
    merge_up_migrations "postgres"
    merge_down_migrations "postgres"
    merge_up_migrations "sqlite"
    merge_down_migrations "sqlite"
elif [[ "${DIALECT}" != "postgres" && "${DIALECT}" != "sqlite" ]]; then
    echo "Error: Invalid dialect '${DIALECT}'. Must be 'postgres' or 'sqlite'."
    exit 1
elif [[ -z "${DIRECTION}" ]]; then
    # Dialect specified, no direction: merge both UP and DOWN
    echo "Merging both UP and DOWN migrations for ${DIALECT}..."
    merge_up_migrations "${DIALECT}"
    merge_down_migrations "${DIALECT}"
elif [[ "${DIRECTION}" == "up" ]]; then
    merge_up_migrations "${DIALECT}"
elif [[ "${DIRECTION}" == "down" ]]; then
    merge_down_migrations "${DIALECT}"
else
    echo "Error: Invalid direction '${DIRECTION}'. Must be 'up' or 'down'."
    exit 1
fi

echo ""
echo "✓ Migration merge complete!"
